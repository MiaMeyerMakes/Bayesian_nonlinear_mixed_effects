---
title: "Literature review Theophylline study"
author: "M Meyer (22675760)"
date: "2024-12-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(nimble)
library(ggplot2)
library(coda)
library(MCMCvis)
library(wesanderson)
library(nlme)
library(knitr)
library(rstan)
library(tidyverse)
```

# Example 2: Theophyline data

Theophylline is a methylxanthine drug used in therapy for respiratory diseases such as chronic obstructive pulmonary disease (COPD) and asthma under a variety of brand names. In the study, Theophylline was administered orally to 12 subjects whose serum concentrations were measured at 11 times over the next 25 hours.

The dataframe has 132 rows and 5 columns of data from the experiment above.

Get an idea of how the data looks:

```{r}
head(Theoph)
# require(stats); require(graphics)
# coplot(conc ~ Time | Subject, data = Theoph, show.given = FALSE)

# Plot using ggplot2
ggplot(Theoph, aes(y = conc, x = Time, color = Subject)) +
  geom_point(size = 2) +
  geom_line(linewidth = 0.8) +
  labs(
    title = "Theophylline data",
    y = "Theophylline concentration (mg/L)",
    x = "Time since drug administration (hr)",
    color = "Subject",
  ) +
  theme_minimal()
```

A nonlinear mixed model is required to correctly capture the mean structure and covariance structure in the dataset. The model proposed by Shuting is the first-order compartment model and is specified as follows:

$$
\begin{aligned}
  C(t) &= \frac{{\text{Dose} \cdot k_{a,i} }}
{{V_i \cdot \left(k_{a,i}-k_{e,i})\right)}}
\left( e^{-k_{e,i}\cdot t_{ij}}-e^{-k_{a,i}\cdot t_{ij}}\right)
+ \epsilon_{ij}\\
C(t) &= \frac{{\text{Dose} \cdot \exp(\beta_1+b_{1i}) }}
{{\exp(\beta_3+b_{3i})\cdot \left(\exp(\beta_1+b_{1i})-\exp(\beta_2+b_{2i})\right)}}
\left( e^{-\exp(\beta_2+b_{2i})\cdot t_{ij}}-e^{-\exp(\beta_1+b_{1i})\cdot t_{ij}}\right)
+ \epsilon_{ij}
\end{aligned}
$$

where

$$
  \epsilon_{ij}\sim N(0, \sigma^2_{res})\\
  k_{a,i}= \exp(\beta_1+b_{1i}),\quad b_{1i}\sim N(0, \sigma^2_{1}) \\
  k_{e,i}= \exp(\beta_2+b_{2i}),\quad b_{2i}\sim N(0, \sigma^2_{2}) \\
  V_i = \exp(\beta_3+b_{3i}),\quad b_{3i}\sim N(0, \sigma^2_{3})
$$

However, in the documentation for `SSfol`, we have the expression for the first-order compartment function as below: `Dose * exp(lKe+lKa-lCl) * (exp(-exp(lKe)*t) - exp(-exp(lKa)*t))/ (exp(lKa) - exp(lKe))`

## Frequentist approach

For the sake of continuing with the analyses, we use the formula from the documentation. From the results for $β_C$ we see that the estimate is $\hat{β}_C=-3.214451$ while for Shuting it was $-0.7818$. This actually seems like a big difference, but the p-values of the results are the same.

See below that get the estimates for the random effects $σ_{b_{1i}}, σ_{b_{2i}}$ amd $σ_{b_{3i}}$ that are the same as those of Shuting.

```{r}

freqmod <- nlme(conc ~ SSfol(Dose, Time, lKe, lKa, lCl),
           data = Theoph,
           fixed = list(lKe + lKa + lCl ~ 1),
           random = lKe + lKa + lCl ~ 1 | Subject,
           start = c(lKe = -2.5, lKa = 0.5, lCl = -3),
           control = nlmeControl(maxIter = 2000, tolerance = 1e-6))
summary(freqmod)

# Fixed effects
fixed.effects(freqmod)

# Random effects
random_effects = ranef(freqmod)

# # Residuals
# residuals(freqmod)

# Extract variance components
variance_components <- VarCorr(freqmod)

# Print the variance components
print(variance_components)

```

```{r}
# Reorder the levels of the Subject column - they were in the wrong order
# Theoph$Subject <- factor(Theoph$Subject, levels = sort(as.numeric(levels(Theoph$Subject))))
Theoph$Subject <- as.numeric(as.factor(Theoph$Subject))
# Add predictions to the data
Theoph$freqpred <- predict(freqmod)  # Population-level predictions

ggplot(Theoph, aes(x = Time, y = conc, color = Subject)) +
  geom_point(size = 2) +
  geom_line(aes(y = freqpred), linetype = "dashed") +
  facet_wrap(~ Subject, scales = "free_y") +  # Facet by Subject
  labs(
    title = "One-Compartment Model Fit",
    x = "Time (hr)",
    y = "Theophylline concentration (mg/L)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")  # Remove legend since facets represent subjects

```

## Bayesian approach

```{r}
Theoph <- datasets::Theoph
```

```{r}
# Prepare data for Stan
stan_data <- list(
  N = nrow(Theoph),
  M = length(unique(Theoph$Subject)),
  y = Theoph$conc,
  Dose = Theoph$Dose,
  Time = Theoph$Time,
  subject = as.numeric(factor(Theoph$Subject))  # Convert subject to numeric index
)

# Compile and run the Stan model
stan_model <- stan_model(file = "theoph_model.stan")
fit <- sampling(stan_model, data = stan_data, iter = 30000, chains = 3, warmup = 5000, seed = 123)

# Summarize the results
summary <- summary(fit, pars = c("beta1", "beta2", "beta3", "sigma_res", "sigma_b1", "sigma_b2", "sigma_b3"))
csum <- summary$c_summary
csum
```

```{r}
beta1 <- csum[1]
beta2 <- csum[2]
beta3 <- csum[3]

input <- Theoph$Time
bayes_pred_theo <- (Theoph$Dose * exp(beta1 - beta3) * (exp(-exp(beta2) * input) - exp(-exp(beta1) * input))) / (exp(beta1) - exp(beta2))

Theoph$bayes_pred <- bayes_pred_theo

# Plot the results
ggplot(Theoph, aes(x = Time, y = conc, color = Subject)) +
  geom_point(size = 2) +
  geom_line(aes(y = bayes_pred), linetype = "dashed") +
  facet_wrap(~ Subject, scales = "free_y") +  # Facet by Subject
  labs(
    title = "One-Compartment Model Fit",
    x = "Time (hr)",
    y = "Theophylline concentration (mg/L)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")  # Remove legend since facets represent subjects
```

```{r}
# Define the Bayesian model
code <- nimbleCode({
  for (i in 1:N) {
    # Likelihood
    y[i] ~ dnorm(mu[i], tau)
    mu[i] <- (Dose[i] * exp(beta1 + b1[subject[i]])) /
             (exp(beta3 + b3[subject[i]]) * (exp(beta1 + b1[subject[i]]) - exp(beta2 + b2[subject[i]]))) *
             (exp(-exp(beta2 + b2[subject[i]]) * Time[i]) - exp(-exp(beta1 + b1[subject[i]]) * Time[i]))
    
  }
  
  # Priors for fixed effects
  beta1 ~ dnorm(0, 1e-6)
  beta2 ~ dnorm(0, 1e-6)
  beta3 ~ dnorm(0, 1e-6)
  
  # Priors for random effects (independent)
  for (j in 1:M) {
    b1[j] ~ dnorm(0, tau_b1)
    b2[j] ~ dnorm(0, tau_b2)
    b3[j] ~ dnorm(0, tau_b3)
  }
  
  # Priors for standard deviations
  sigma_res ~ dunif(0, 100)
  sigma_b1 ~ dunif(0, 100)
  sigma_b2 ~ dunif(0, 100)
  sigma_b3 ~ dunif(0, 100)
  
  # Transform standard deviations to precision
  tau <- 1 / (sigma_res^2)
  tau_b1 <- 1 / (sigma_b1^2)
  tau_b2 <- 1 / (sigma_b2^2)
  tau_b3 <- 1 / (sigma_b3^2)
})

# Prepare data
data <- list(
  y = Theoph$conc,
  Dose = Theoph$Dose,
  Time = Theoph$Time,
  subject = as.numeric(factor(Theoph$Subject))  # Convert subject to numeric index
)

# Constants
constants <- list(
  N = nrow(Theoph),
  M = length(unique(Theoph$Subject))  # Number of subjects
)

# Initial values
inits <- list(
  beta1 = rnorm(1, 0, 1),
  beta2 = rnorm(1, 0, 1),
  beta3 = rnorm(1, 0, 1),
  b1 = rnorm(constants$M, 0, 1),
  b2 = rnorm(constants$M, 0, 1),
  b3 = rnorm(constants$M, 0, 1),
  sigma_res = runif(1, 0, 100),
  sigma_b1 = runif(1, 0, 100),
  sigma_b2 = runif(1, 0, 100),
  sigma_b3 = runif(1, 0, 100)
)
```

```{r}
# Build the model
model <- nimbleModel(code, data = data, constants = constants, inits = inits)

# Compile the model
compiled_model <- compileNimble(model)

# Configure MCMC
mcmc_config <- configureMCMC(model)

# Build MCMC
mcmc <- buildMCMC(mcmc_config)

# Compile MCMC
compiled_mcmc <- compileNimble(mcmc, project = model)

# Run MCMC
set.seed(123)
samples <- runMCMC(compiled_mcmc, niter = 30000, nchains = 3, nburnin = 5000)
```

```{r}
# Load MCMCvis
library(MCMCvis)

# Summarize the results
samples_summary <- MCMCsummary(samples, round = 8)
print(samples_summary)

# CHECK FOR CONVERGENCE
# Check Rhat values
print(samples_summary[, "Rhat"])
```

Visualize the results:

```{r}
# Trace plots and density plots
# MCMCtrace(samples, params = c("beta1", "beta2", "beta3", "sigma_res", "sigma_b1", "sigma_b2", "sigma_b3"))

```

When removing $β_2$ from the numerator (in fitting the model) like it is in Shuting's code we. Note that the model estimate is now also different for the $β_2$ parameter at -0.7762. This is closer to Shuting's answer. But something still feels off from the plot.

```{r}
set.seed(123)

bayes_pars = samples_summary$mean


beta1 <- bayes_pars[1]
beta2 <- bayes_pars[2]
beta3 <- bayes_pars[3]

input = Theoph$Time

  # Calculate predictions for each posterior sample
bayes_pred_theo <- (Theoph$Dose * exp(beta1-beta3) * (exp(-exp(beta2)*input) - exp(-exp(beta1)*input)))/ (exp(beta1) - exp(beta2))

Theoph$bayes_pred <- bayes_pred_theo

ggplot(Theoph, aes(x = Time, y = conc, color = Subject)) +
  geom_point(size = 2) +
  geom_line(aes(y = bayes_pred), linetype = "dashed") +
  facet_wrap(~ Subject, scales = "free_y") +  # Facet by Subject
  labs(
    title = "One-Compartment Model Fit",
    x = "Time (hr)",
    y = "Theophylline concentration (mg/L)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")  # Remove legend since facets represent subjects
```
